–ù–∏–∂–µ –¥–∞—é **–æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–µ –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ –¥–ª—è –±—ç–∫–µ–Ω–¥–∞**, —É—á–∏—Ç—ã–≤–∞—è:

* IP –±–æ–ª—å—à–µ **–Ω–µ —à–∏—Ñ—Ä—É–µ–º**, –∞ **—Ö—Ä–∞–Ω–∏–º –≤ cookie**
* —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ **–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç IP –≤ header**
* –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞—Ö–æ–¥–µ ‚Äî –∑–∞–ø—Ä–æ—Å `/auth-user`
* backend **—Å–æ–∑–¥–∞—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ**, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
* –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `id`, `avatarId`, `username`
* –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ OAuth ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äú–ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è‚Äù, –∏ –¥–∞–ª—å–Ω–µ–π—à–∞—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏–¥—ë—Ç —É–∂–µ –ø–æ userId

---

# üõ† –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ: Backend

## üìå 1. –û–±—â–∏–π –æ–±–∑–æ—Ä

–ù–µ–æ–±—Ö–æ–¥–∏–º —Å–µ—Ä–≤–µ—Ä (Node.js + Express / Nest.js ‚Äî –ª—é–±–æ–π —Å—Ç—ç–∫), –∫–æ—Ç–æ—Ä—ã–π –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–≤–∞ —Ç–∏–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:

1. **Anon user** ‚Äî –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ IP
2. **Authorized user** ‚Äî –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ userId

Backend –æ–±—è–∑–∞–Ω:

* –ø—Ä–∏–Ω–∏–º–∞—Ç—å IP –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞
* —Ö—Ä–∞–Ω–∏—Ç—å IP –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ
* –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å `username` + `avatarId`
* —Å–ª–µ–¥–∏—Ç—å –∑–∞ —Ç–æ–∫–µ–Ω–∞–º–∏ (‚Äú–±–∞–ª–∞–Ω—Å–æ–º‚Äù)
* –ø—Ä–∏–≤—è–∑—ã–≤–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç –ø–æ—Å–ª–µ OAuth
* –æ–±–µ—Å–ø–µ—á–∏–≤–∞—Ç—å –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–º–µ–Ω–∏ –∏ –∞–≤–∞—Ç–∞—Ä–∞

---

# üìå 2. API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

## 2.1 `POST /auth-user`

–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

### **–§—Ä–æ–Ω—Ç–µ–Ω–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç:**

* –í **–∑–∞–≥–æ–ª–æ–≤–∫–µ**: `x-user-ip: {ip}`
* –í cookie –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —ç—Ç–æ—Ç –∂–µ IP (–¥–ª—è –∫—Ä–æ—Å—Å-–≤–∞–ª–∏–¥–∞—Ü–∏–∏)

### **Backend –≤—ã–ø–æ–ª–Ω—è–µ—Ç:**

1. –ë–µ—Ä—ë—Ç IP –∏–∑ `x-user-ip`
2. –ò—â–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ –ø–æ IP
3. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω:

   * –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç

     * `id`
     * `avatarId` (1‚Äì5)
     * `username` (–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ IP)
     * `tokens = 5`
     * `tokensUsedAsAnon = 0`
   * —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
4. –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ
5. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç:

```json
{
  "id": "uuid",
  "username": "–ú–æ–≥—É—á–∏–π –ø–∏–Ω–≥–≤–∏–Ω",
  "avatarId": 3,
  "tokens": 5,
  "tokensUsedAsAnon": 1,
  "isAuthorized": false
}
```

### –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

* –ê–Ω–æ–Ω–∏–º–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–º–∞–∫—Å–∏–º—É–º 2 —Ç–æ–∫–µ–Ω–∞**, –ø–æ—Å–ª–µ —á–µ–≥–æ —Ñ—Ä–æ–Ω—Ç –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.
* –í—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ userId (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω).

---

## 2.2 `POST /oauth/callback`

Callback –æ—Ç VK/Google/Yandex.

### Backend –≤—ã–ø–æ–ª–Ω—è–µ—Ç:

1. –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ OAuth (email, socialId)
2. –ò—â–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

   * –ø–æ socialId
   * –∏–ª–∏ –ø–æ email
3. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω:

   * —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   * –µ—Å–ª–∏ –≤ cookie –µ—Å—Ç—å IP, –∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç anon user ‚Üí **–ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç –µ–≥–æ –¥–∞–Ω–Ω—ã–µ** –∫ –Ω–æ–≤–æ–º—É –∞–∫–∫–∞—É–Ω—Ç—É
4. –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω anon user —Å —Ç–∞–∫–∏–º –∂–µ IP ‚Äî –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç:

   * –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç —Ç–æ–∫–µ–Ω—ã
   * –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç username
   * –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç avatarId
5. –ü–æ–º–µ—á–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ `isAuthorized = true`

### –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:

```json
{
  "id": "uuid",
  "username": "–ú–æ–≥—É—á–∞—è –ø–∞–Ω–¥–∞",
  "avatarId": 2,
  "tokens": 5,
  "isAuthorized": true
}
```

---

## 2.3 `POST /use-token`

–ó–∞–ø—Ä–æ—Å –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞.

### Backend –≤—ã–ø–æ–ª–Ω—è–µ—Ç:

1. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (IP –∏–ª–∏ ID)
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
3. –î–ª—è –∞–Ω–æ–Ω–∏–º–∞:

   * –µ—Å–ª–∏ `tokensUsedAsAnon >= 2` ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–¥ `403` (authorization required)
4. –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω–æ–≤ –Ω–µ—Ç ‚Üí `402` (payment required)
5. –ï—Å–ª–∏ –µ—Å—Ç—å:

   * —É–º–µ–Ω—å—à–∞–µ—Ç `tokens`
   * —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç `tokensUsedAsAnon` (–µ—Å–ª–∏ anon)

### –û—Ç–≤–µ—Ç:

```json
{ "success": true, "tokensLeft": 3 }
```

---

# üìå 3. –ú–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–ü—Ä–∏–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã `User`:

| –ü–æ–ª–µ             | –¢–∏–ø     | –û–ø–∏—Å–∞–Ω–∏–µ                             |
| ---------------- | ------- | ------------------------------------ |
| id               | uuid    | –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á                       |
| ip               | string  | IP –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è                      |
| avatarId         | number  | 1‚Äì5                                  |
| username         | string  | –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–º—è |
| tokens           | number  | default: 5                           |
| tokensUsedAsAnon | number  | default: 0                           |
| isAuthorized     | boolean | default: false                       |
| socialId         | string? | id VK/Google/Yandex                  |
| email            | string? | email –∏–∑ OAuth                       |
| createdAt        | date    |                                      |
| updatedAt        | date    |                                      |

---

# üìå 4. –ê–ª–≥–æ—Ä–∏—Ç–º –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ username –∏ avatarId

–ì–µ–Ω–µ—Ä–∞—Ü–∏—è **—Å—Ç—Ä–æ–≥–æ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è**, —á—Ç–æ–±—ã –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π IP –≤–æ–∑–≤—Ä–∞—â–∞–ª –≤—Å–µ–≥–¥–∞ –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ.

### –ñ–∏–≤–æ—Ç–Ω—ã–µ:

1. –ª–∏—Å–∞
2. –ø–∞–Ω–¥–∞
3. –µ–Ω–æ—Ç
4. —Å–æ–≤–∞
5. –ø–∏–Ω–≥–≤–∏–Ω

### –ü—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã–µ:

`["–ú–æ–≥—É—á–∏–π", "–ò–≥—Ä–∏–≤—ã–π", "–°–º—É–≥–ª—ã–π", "–û—Ç–≤–∞–∂–Ω—ã–π", "–õ—É–∫–∞–≤—ã–π", ...]`
(—Å–ø–∏—Å–æ–∫ –∏–∑ 20‚Äì50 –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã—Ö)

---

## –§–æ—Ä–º—É–ª–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

```ts
function hash(str) {
  let h = 0;
  for (let i = 0; i < str.length; i++) {
    h = (h * 31 + str.charCodeAt(i)) >>> 0;
  }
  return h;
}

function getAvatarId(ip) {
  return (hash(ip) % 5) + 1; // 1..5
}

function getUsername(ip) {
  const animals = ["–ª–∏—Å–∞", "–ø–∞–Ω–¥–∞", "–µ–Ω–æ—Ç", "—Å–æ–≤–∞", "–ø–∏–Ω–≥–≤–∏–Ω"];
  const adjectives = ["–ú–æ–≥—É—á–∏–π", "–ò–≥—Ä–∏–≤—ã–π", "–°–º–µ–ª—ã–π", "–õ–æ–≤–∫–∏–π", "–•–∏—Ç—Ä—ã–π", "–î–æ–±–ª–µ—Å—Ç–Ω—ã–π"];

  const h = hash(ip);
  const adj = adjectives[h % adjectives.length];
  const animal = animals[h % animals.length];

  return `${adj} ${animal}`;
}
```

Backend –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **—Ç–æ—á–Ω–æ —Ç–∞–∫–æ–π –∂–µ –∞–ª–≥–æ—Ä–∏—Ç–º**, –∫–∞–∫ frontend ‚Äî —á—Ç–æ–±—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–æ–≤–ø–∞–¥–∞–ª–∞.

---

# üìå 5. –õ–æ–≥–∏–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤

### –ê–Ω–æ–Ω–∏–º–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

* –≤—Å–µ–≥–æ —Ç–æ–∫–µ–Ω–æ–≤ ‚Äî 5
* –º–æ–∂–Ω–æ –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ‚Äî 2
* –¥–∞–ª—å—à–µ ‚Äî –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

* —Ä–∞–±–æ—Ç–∞–µ—Ç —É–∂–µ –ø–æ userId
* —Ç–æ–∫–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∏ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ IP

---

# üìå 6. Cookies

Frontend —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç:

* `user_ip` ‚Äî —á–∏—Å—Ç—ã–π IP
* `auth_token` ‚Äî JWT/Session id –æ—Ç OAuth (–µ—Å–ª–∏ –µ—Å—Ç—å)

Backend —á–∏—Ç–∞–µ—Ç:

* `user_ip` –¥–ª—è —Å–≤—è–∑–∏ –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
* JWT —Ç–æ–∫–µ–Ω, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω

---

# üìå 7. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

* Backend **–Ω–µ –¥–æ–ª–∂–µ–Ω –¥–æ–≤–µ—Ä—è—Ç—å** IP –≤ cookie ‚Üí —Ç–æ–ª—å–∫–æ header `x-user-ip`
* –ó–∞–ø—Ä–µ—â–µ–Ω–æ –ª—é–±–æ–π –ª–æ–≥–∏–∫–æ–π –ø–æ–∑–≤–æ–ª—è—Ç—å –º–µ–Ω—è—Ç—å IP —Å–∞–º–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏ –ø–æ–ª—É—á–∞—Ç—å –Ω–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã
* –ó–∞–ø—Ä–µ—â–µ–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤–æ–≥–æ anon user –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∑–∞—Ö–æ–¥–µ ‚Üí –±–∞–∑–∞ —Ö—Ä–∞–Ω–∏—Ç IP –æ–¥–∏–Ω —Ä–∞–∑
* –¢–æ–ª—å–∫–æ backend —Ä–µ—à–∞–µ—Ç, –∫–æ–≥–æ —Å—á–∏—Ç–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

---

# üìå 8. –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏ anon user ‚Üí authorized user

–ü—Ä–∏ OAuth:

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç `authorizedUser`
2. –ï—Å–ª–∏ –≤ cookie –µ—Å—Ç—å IP, –∏ anon user —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî backend –¥–µ–ª–∞–µ—Ç merge:

   * –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç avatarId
   * –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç username
   * –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç –æ—Å—Ç–∞—Ç–æ–∫ —Ç–æ–∫–µ–Ω–æ–≤
3. anon user –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ merged

---

# üìå 9. –ß—Ç–æ –≤–µ—Ä–Ω—É—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—É –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞—Ö–æ–¥–µ

```json
{
  "id": "uuid",
  "username": "–õ–æ–≤–∫–∞—è –ª–∏—Å–∞",
  "avatarId": 1,
  "tokens": 5,
  "tokensUsedAsAnon": 0,
  "isAuthorized": false
}
```

---

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî –º–æ–≥—É –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å:

‚úÖ –¢–ó –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
‚úÖ –¢–ó –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (PostgreSQL/Mongo)
‚úÖ –ì–æ—Ç–æ–≤—ã–π backend –Ω–∞ Express –∏–ª–∏ Nest.js
‚úî –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—á—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
‚úî –ü—Ä–∏–º–µ—Ä axios middleware + jotai store

–° —á–µ–≥–æ –ø—Ä–æ–¥–æ–ª–∂–∏–º?
